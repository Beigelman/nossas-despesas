name: Backend Deploy

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**"
      - ".github/workflows/backend-deploy.yml"

env:
  ENV: prd
  PROJECT_ID: nossas-despesas
  GAR_LOCATION: us-east1
  SERVICE: nossas-despesas-be
  REGION: us-east1
  TESTCONTAINERS_RYUK_DISABLED: true

jobs:
  test:
    name: Test and Lint
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: "actions/setup-go@v5"
        with:
          go-version: "1.25.3"
          
      - name: Lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.6.1
          args: --timeout=5m
          working-directory: backend

      - name: Test
        run: |
          cd backend
          go test -v -failfast ./...
      

  deploy:
    name: Build and Deploy
    needs: test
    # Add 'id-token' with the intended permissions for workload identity federation
    permissions:
      contents: "write"
      id-token: "write"

    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: "actions/checkout@v4"
        with:
          fetch-depth: 0

      - name: Generate Semantic Version
        id: tag
        run: |
          # Busca a última tag semântica para backend
          LATEST_TAG=$(git tag --sort=-version:refname | grep '^backend-v[0-9]\+\.[0-9]\+\.[0-9]\+$' | head -1)
          
          if [ -z "$LATEST_TAG" ]; then
            # Se não há tags, começa com backend-v1.0.0
            NEW_VERSION="backend-v1.0.0"
          else
            # Extrai os números da versão
            MAJOR=$(echo $LATEST_TAG | sed 's/backend-v\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)/\1/')
            MINOR=$(echo $LATEST_TAG | sed 's/backend-v\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)/\2/')
            PATCH=$(echo $LATEST_TAG | sed 's/backend-v\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)/\3/')
            
            # Incrementa patch version
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="backend-v${MAJOR}.${MINOR}.${NEW_PATCH}"
          fi
          
          echo "tag=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "Generated semantic version: ${NEW_VERSION}"

      - name: Create and Push Git Tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag ${{ steps.tag.outputs.tag }}
          git push origin ${{ steps.tag.outputs.tag }}

      - name: Google Auth
        id: auth
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.SA_CREDENTIALS }}"

      - name: Docker Auth
        id: docker-auth
        uses: "docker/login-action@v3"
        with:
          registry: "${{ env.GAR_LOCATION }}-docker.pkg.dev"
          username: _json_key
          password: ${{ secrets.SA_CREDENTIALS }}

      - name: Build and Push Container
        run: |-
          # Build com múltiplas tags usando o Dockerfile do backend
          docker build \
            -f backend/Dockerfile \
            -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/docker/${{ env.SERVICE }}:${{ steps.tag.outputs.tag }}" \
            -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/docker/${{ env.SERVICE }}:latest" \
            ./
          
          # Push de todas as tags
          docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/docker/${{ env.SERVICE }}:${{ steps.tag.outputs.tag }}"
          docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/docker/${{ env.SERVICE }}:latest"

      - name: Run Database Migrations
        env:
          DB_CONNECTION_STRING: ${{ secrets.MIGRATION_DB_CONNECTION_STRING }}
        run: |
          # Instala go-migrate se necessário
          if ! command -v migrate &> /dev/null; then
            echo "Installing go-migrate..."
            curl -L https://github.com/golang-migrate/migrate/releases/download/v4.18.1/migrate.linux-amd64.tar.gz | tar xvz
            sudo mv migrate /usr/local/bin/migrate
          fi
          
          # Executa as migrations
          echo "Running database migrations..."
          chmod +x ./backend/database/migrate.sh
          
          # Define variáveis adicionais para resolver problemas de prepared statement
          export MIGRATION_TIMEOUT=30s
          export MIGRATION_RETRY_ATTEMPTS=3
          
          cd backend
          ./database/migrate.sh up "./database/migrations"
          
          echo "Migrations completed successfully!"
      - name: Deploy to Cloud Run
        id: deploy
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: ${{ env.SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/docker/${{ env.SERVICE }}:${{ steps.tag.outputs.tag }}
          flags: | 
            --service-account=default@${{ env.PROJECT_ID }}.iam.gserviceaccount.com 
            --allow-unauthenticated
          env_vars: |
            ENV=${{ env.ENV }}
            JWT_KEY=${{ secrets.JWT_KEY }}
            DB_CONNECTION_STRING=${{ secrets.DB_CONNECTION_STRING }}
            MAIL_API_KEY=${{ secrets.MAIL_API_KEY }}

      - name: Show Output
        run: |
          echo "Deployed URL: ${{ steps.deploy.outputs.url }}"
          echo "Image tag: ${{ steps.tag.outputs.tag }}"
